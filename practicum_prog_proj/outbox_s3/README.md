# Outbox S3 Worker Service

## Обзор

**Outbox S3 Worker** — реализация паттерна Transactional Outbox для надёжного сохранения результатов детекции в объектное хранилище S3 (MinIO). Сервис обеспечивает гарантированное сохранение JSON результатов детекции из MongoDB в MinIO.

## Основные функции

1. **Опрос MongoDB runner_db.runner_predictions** на записи со статусом `"predictable"`
2. **Чтение данных** из записи в runner_db: `event_id`, `bucket` и `prediction` (финальный JSON)
3. **Сохранение prediction JSON** в MinIO по пути `detection/{event_id}.json`
4. **Обновление статуса** в runner_db на `"ready"` 
5. **Сохранение пути** к файлу в `output_s3` в runner_db
6. **Сохранение данных** в runner_db 

## Паттерн Transactional Outbox для S3 — подробное объяснение

### Что такое Transactional Outbox для S3

**Transactional Outbox для S3** — это адаптация паттерна Transactional Outbox для надёжного сохранения результатов в объектное хранилище (S3/MinIO). Паттерн решает проблему надёжного сохранения результатов детекции в распределённых системах с микросервисной архитектурой.

**Принцип работы**:
1. **Подготовка результата**: Runner сервис сохраняет результат в `runner_db.runner_predictions` со статусом `"predictable"`
2. **Асинхронное сохранение**: Outbox S3 worker ищет записи напрямую в `runner_db` со статусом `"predictable"` и сохраняет в S3
3. **Гарантия сохранения**: Данные остаются в `runner_db` после сохранения в S3 (для истории)
4. **Завершение процесса**: Обновление статуса на `"ready"` в runner_db после успешного сохранения в S3

### Преимущества паттерна

- **Надёжность**: Результаты не теряются при сбоях MinIO или сети
- **Согласованность**: Транзакционная целостность данных (запись в БД и outbox атомарна)
- **Масштабируемость**: Можно запускать несколько worker'ов для параллельной обработки
- **Отказоустойчивость**: Автоматические повторные попытки при временных сбоях
- **Идемпотентность**: Повторная обработка безопасна (статус обновляется только после успеха)
- **Микросервисная архитектура**: Использует отдельную БД runner_db для изоляции сервисов
- **Сохранение истории**: Данные остаются в runner_db после сохранения в S3 для аналитики

### Статусы обработки (внутренние, в runner_db)
- `predictable` — Данные готовы для чтения из runner_db и сохранения в S3 (статус в runner_db.runner_predictions)
- `ready` — Результат успешно сохранён в S3 (статус в runner_db.runner_predictions)

## Отказоустойчивость и проверка доступности сервисов

### Проверка доступности MinIO
### Проверка доступности MongoDB

## Идемпотентность

**Идемпотентные операции**:
- **Проверка статуса**: Обработка только записей со статусом "predictable"
- **Проверка существования**: Проверка наличия файла в S3 перед сохранением
- **Условное обновление**: Статус обновляется только при совпадении условий