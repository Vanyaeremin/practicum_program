# API Checkout Service


**API Checkout Service** — входная точка системы детекции объектов на видео. Сервис отвечает за приём видео от пользователей, сохранение в объектное хранилище и создание событий для асинхронной обработки.

## Основные функции

1. **Приём и загрузка видео** 
2. **Сохранение видео в MinIO (бакет videos)** 
3. **Создание событий в MainDB** 
4. **Предоставление результатов детекции через API эндпоинты** 
5. **Мониторинг статусов обработки видео в реальном времени**

## Архитектура и взаимодействие

### Процесс загрузки видео
1. **Получение видео**: Клиент отправляет видеофайл через POST запрос на `/api/upload_video`
2. **Генерация ID**: Создаётся уникальный `video_id` (UUID4 - это случайно сгенерированный 128-битный идентификатор)
3. **Сохранение в MinIO**: Видео сохраняется по пути `input/{video_id}.mp4`
4. **Создание события**: В MongoDB outbox создаётся запись со статусом `"new"`
5. **Асинхронная обработка**: Outbox worker забирает событие и отправляет в Kafka

## Технические детали

### Борьба с GIL (Global Interpreter Lock)

**GIL (Global Interpreter Lock)** — это механизм в CPython, который предотвращает одновременное выполнение байт-кода несколькими потоками в одном процессе.

**Проблема в API Checkout Service**:
- Операции с MongoDB и MinIO — I/O операции, но выполняются через синхронные клиенты
- Если выполнять эти операции в основном потоке, event loop блокируется

**Решение**:
- **ThreadPoolExecutor** (через `run_in_executor(None, ...)`) для I/O операций:
  - MongoDB операции
  - MinIO операции
  - Event loop не блокируется

**Примечание**: API Checkout Service выполняет I/O операции (MongoDB, MinIO), которые не требуют CPU-интенсивной обработки. Поэтому используется `ThreadPoolExecutor`, а не `ProcessPoolExecutor`.

## Примеры использования

### Загрузка видео
```bash
curl -X POST "http://localhost:8080/api/upload_video" \
  -F "file=@video.mp4" \
  -F "bucket=videos"
```

Ответ:
```json
{
  "status": "ok",
  "event_id": "123e4567-e89b-12d3-a456-426614174000"
}
```

### Получение статуса
```bash
curl "http://localhost:8080/api/status/all"
```

### Получение результата
```bash
curl "http://localhost:8080/api/result_video/123e4567-e89b-12d3-a456-426614174000"
```

## Отказоустойчивость и проверка доступности сервисов

### Проверка доступности MongoDB и MinIO

Сервис обрабатывает ошибки MongoDB и MinIO с логированием и возвратом соответствующих HTTP статусов.

**Преимущества**:
- **Обработка ошибок**: Все ошибки MongoDB и MinIO логируются
- **Graceful degradation**: При ошибке возвращается пустой список или HTTP ошибка
- **Продолжение работы**: Сервис продолжает работать при временных сбоях БД